name: Goodnotes Load Testing CI

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install KinD
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Create KinD cluster
        run: |
          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          - role: worker
          - role: worker
          EOF

      - name: Verify cluster nodes
        run: |
          kubectl get nodes
          kubectl wait --for=condition=Ready nodes --all --timeout=300s

      - name: Install NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          
      - name: Wait for Ingress Controller
        run: |
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=300s

      - name: Deploy http-echo applications
        run: |
          # Create foo deployment
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foo
            labels:
              app: foo
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: foo
            template:
              metadata:
                labels:
                  app: foo
              spec:
                containers:
                - name: http-echo
                  image: hashicorp/http-echo:latest
                  args:
                    - "-text=foo"
                  ports:
                  - containerPort: 5678
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 5
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foo-service
          spec:
            selector:
              app: foo
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5678
          EOF

          # Create bar deployment
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: bar
            labels:
              app: bar
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: bar
            template:
              metadata:
                labels:
                  app: bar
              spec:
                containers:
                - name: http-echo
                  image: hashicorp/http-echo:latest
                  args:
                    - "-text=bar"
                  ports:
                  - containerPort: 5678
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 5
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: bar-service
          spec:
            selector:
              app: bar
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5678
          EOF

      - name: Configure Ingress routing
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: echo-ingress
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
          spec:
            ingressClassName: nginx
            rules:
            - host: foo.localhost
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: foo-service
                      port:
                        number: 80
            - host: bar.localhost
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: bar-service
                      port:
                        number: 80
          EOF

      - name: Wait for deployments to be ready
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/foo
          kubectl wait --for=condition=available --timeout=300s deployment/bar
          
          # Verify pods are running
          kubectl get pods -o wide
          
          # Verify ingress is configured
          kubectl get ingress

      - name: Verify ingress health
        run: |
          # port forward ingress controller to localhost
          kubectl port-forward --namespace ingress-nginx svc/ingress-nginx-controller 8080:80 &
          
          # Wait a bit for ingress to fully configure
          sleep 10
          
          # Test foo endpoint
          curl -H "Host: foo.localhost" http://localhost:8080/ || exit 1
          
          # Test bar endpoint
          curl -H "Host: bar.localhost" http://localhost:8080/ || exit 1
          
          echo "‚úÖ Both ingress endpoints are healthy"

      - name: Install Apache Bench for load testing
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils

      - name: Run load tests
        id: load_test
        run: |
          # Create load test script
          cat > load_test.sh << 'SCRIPT'
          #!/bin/bash
          
          OUTPUT_FILE="load_test_results.txt"
          JSON_FILE="load_test_results.json"
          > $OUTPUT_FILE
          
          echo "üöÄ Starting Load Tests" | tee -a $OUTPUT_FILE
          echo "===========================================" | tee -a $OUTPUT_FILE
          echo "" | tee -a $OUTPUT_FILE
          
          # Test parameters
          REQUESTS=2000
          CONCURRENCY=50
          
          # Function to extract and format metrics
          extract_metrics() {
            local ab_output=$1
            local host=$2
            
            # Extract values
            local complete=$(echo "$ab_output" | grep "Complete requests:" | awk '{print $3}')
            local failed=$(echo "$ab_output" | grep "Failed requests:" | awk '{print $3}')
            local rps=$(echo "$ab_output" | grep "Requests per second:" | awk '{print $4}')
            local mean_time=$(echo "$ab_output" | grep "Time per request:" | head -1 | awk '{print $4}')
            local total_time=$(echo "$ab_output" | grep "Time taken for tests:" | awk '{print $5}')
            
            # Extract percentiles
            local p50=$(echo "$ab_output" | grep "50%" | awk '{print $2}')
            local p66=$(echo "$ab_output" | grep "66%" | awk '{print $2}')
            local p75=$(echo "$ab_output" | grep "75%" | awk '{print $2}')
            local p80=$(echo "$ab_output" | grep "80%" | awk '{print $2}')
            local p90=$(echo "$ab_output" | grep "90%" | awk '{print $2}')
            local p95=$(echo "$ab_output" | grep "95%" | awk '{print $2}')
            local p98=$(echo "$ab_output" | grep "98%" | awk '{print $2}')
            local p99=$(echo "$ab_output" | grep "99%" | awk '{print $2}')
            local p100=$(echo "$ab_output" | grep "100%" | awk '{print $2}')
            
            # Calculate failure percentage
            local failed_pct=0
            if [ "$complete" -gt 0 ]; then
              failed_pct=$(echo "scale=2; ($failed / $complete) * 100" | bc)
            fi
            
            # Format output
            echo "üìä Load Test Results for $host" | tee -a $OUTPUT_FILE
            echo "-------------------------------------------" | tee -a $OUTPUT_FILE
            echo "" | tee -a $OUTPUT_FILE
            
            echo "Request Statistics:" | tee -a $OUTPUT_FILE
            echo "  ‚úì Total Requests:        $complete" | tee -a $OUTPUT_FILE
            echo "  ‚úó Failed Requests:       $failed ($failed_pct%)" | tee -a $OUTPUT_FILE
            echo "  ‚ö° Requests/sec:          $rps req/s" | tee -a $OUTPUT_FILE
            echo "  ‚è±Ô∏è  Total Time:            $total_time seconds" | tee -a $OUTPUT_FILE
            echo "" | tee -a $OUTPUT_FILE
            
            echo "Response Time Statistics (ms):" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ Average (Mean):        $mean_time ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 50th Percentile (p50): $p50 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 66th Percentile (p66): $p66 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 75th Percentile (p75): $p75 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 80th Percentile (p80): $p80 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 90th Percentile (p90): $p90 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 95th Percentile (p95): $p95 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 98th Percentile (p98): $p98 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ 99th Percentile (p99): $p99 ms" | tee -a $OUTPUT_FILE
            echo "  ‚Ä¢ Max (p100):            $p100 ms" | tee -a $OUTPUT_FILE
            echo "" | tee -a $OUTPUT_FILE
            
            # Store JSON data for summary
            cat >> $JSON_FILE << EOF
          {
            "host": "$host",
            "total_requests": $complete,
            "failed_requests": $failed,
            "failed_percentage": $failed_pct,
            "requests_per_second": $rps,
            "total_time_seconds": $total_time,
            "response_times_ms": {
              "mean": $mean_time,
              "p50": $p50,
              "p66": $p66,
              "p75": $p75,
              "p80": $p80,
              "p90": $p90,
              "p95": $p95,
              "p98": $p98,
              "p99": $p99,
              "p100": $p100
            }
          }
          EOF
          }
          
          # Function to run load test
          run_load_test() {
            local host=$1
            local url=$2
            
            echo "üéØ Testing $host..." | tee -a $OUTPUT_FILE
            echo "" | tee -a $OUTPUT_FILE
            
            # Run Apache Bench and capture output
            ab_output=$(ab -n $REQUESTS -c $CONCURRENCY -H "Host: $host" $url 2>&1)
            
            # Extract and format metrics
            extract_metrics "$ab_output" "$host"
            
            echo "===========================================" | tee -a $OUTPUT_FILE
            echo "" | tee -a $OUTPUT_FILE
          }
          
          # Initialize JSON file
          echo "[" > $JSON_FILE
          
          # Run tests for both services
          run_load_test "foo.localhost" "http://localhost:8080/"
          echo "," >> $JSON_FILE
          run_load_test "bar.localhost" "http://localhost:8080/"
          
          # Close JSON array
          echo "]" >> $JSON_FILE
          
          # Create summary table
          echo "üìà Summary Comparison Table" | tee -a $OUTPUT_FILE
          echo "===========================================" | tee -a $OUTPUT_FILE
          echo "" | tee -a $OUTPUT_FILE
          
          # Extract data from JSON for table
          foo_rps=$(cat $JSON_FILE | grep -A 20 "foo.localhost" | grep "requests_per_second" | awk -F': ' '{print $2}' | tr -d ',')
          bar_rps=$(cat $JSON_FILE | grep -A 20 "bar.localhost" | grep "requests_per_second" | awk -F': ' '{print $2}' | tr -d ',')
          
          foo_failed=$(cat $JSON_FILE | grep -A 20 "foo.localhost" | grep "failed_percentage" | awk -F': ' '{print $2}' | tr -d ',')
          bar_failed=$(cat $JSON_FILE | grep -A 20 "bar.localhost" | grep "failed_percentage" | awk -F': ' '{print $2}' | tr -d ',')
          
          foo_p50=$(cat $JSON_FILE | grep -A 20 "foo.localhost" | grep "\"p50\"" | awk -F': ' '{print $2}' | tr -d ',')
          bar_p50=$(cat $JSON_FILE | grep -A 20 "bar.localhost" | grep "\"p50\"" | awk -F': ' '{print $2}' | tr -d ',')
          
          foo_p90=$(cat $JSON_FILE | grep -A 20 "foo.localhost" | grep "\"p90\"" | awk -F': ' '{print $2}' | tr -d ',')
          bar_p90=$(cat $JSON_FILE | grep -A 20 "bar.localhost" | grep "\"p90\"" | awk -F': ' '{print $2}' | tr -d ',')
          
          foo_p95=$(cat $JSON_FILE | grep -A 20 "foo.localhost" | grep "\"p95\"" | awk -F': ' '{print $2}' | tr -d ',')
          bar_p95=$(cat $JSON_FILE | grep -A 20 "bar.localhost" | grep "\"p95\"" | awk -F': ' '{print $2}' | tr -d ',')
          
          foo_p99=$(cat $JSON_FILE | grep -A 20 "foo.localhost" | grep "\"p99\"" | awk -F': ' '{print $2}' | tr -d ',')
          bar_p99=$(cat $JSON_FILE | grep -A 20 "bar.localhost" | grep "\"p99\"" | awk -F': ' '{print $2}' | tr -d ',')
          
          printf "| %-20s | %-15s | %-15s |\n" "Metric" "foo.localhost" "bar.localhost" | tee -a $OUTPUT_FILE
          printf "|%s|%s|%s|\n" "----------------------" "-----------------" "-----------------" | tee -a $OUTPUT_FILE
          printf "| %-20s | %-15s | %-15s |\n" "Requests/sec" "${foo_rps} req/s" "${bar_rps} req/s" | tee -a $OUTPUT_FILE
          printf "| %-20s | %-15s | %-15s |\n" "Failed %" "${foo_failed}%" "${bar_failed}%" | tee -a $OUTPUT_FILE
          printf "| %-20s | %-15s | %-15s |\n" "p50 (median)" "${foo_p50} ms" "${bar_p50} ms" | tee -a $OUTPUT_FILE
          printf "| %-20s | %-15s | %-15s |\n" "p90" "${foo_p90} ms" "${bar_p90} ms" | tee -a $OUTPUT_FILE
          printf "| %-20s | %-15s | %-15s |\n" "p95" "${foo_p95} ms" "${bar_p95} ms" | tee -a $OUTPUT_FILE
          printf "| %-20s | %-15s | %-15s |\n" "p99" "${foo_p99} ms" "${bar_p99} ms" | tee -a $OUTPUT_FILE
          
          echo "" | tee -a $OUTPUT_FILE
          echo "‚úÖ Load testing completed successfully!" | tee -a $OUTPUT_FILE
          
          cat $OUTPUT_FILE
          SCRIPT
          
          chmod +x load_test.sh
          ./load_test.sh
          
          # Set output for PR comment
          echo "RESULTS<<EOF" >> $GITHUB_OUTPUT
          cat load_test_results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post results to PR
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.load_test.outputs.RESULTS }}`;
            
            const comment = `## üß™ Kubernetes Load Test Results
            
            **Cluster Configuration:**
            - Multi-node KinD cluster (3 nodes: 1 control-plane, 2 workers)
            - NGINX Ingress Controller
            - 2 http-echo deployments (foo and bar, 2 replicas each)
            
            **Test Configuration:**
            - Total Requests: 2000 per service
            - Concurrency: 50 concurrent requests
            - Test Tool: Apache Bench (ab)
            
            ---
            
            <details>
            <summary>üìä Detailed Load Test Results (Click to expand)</summary>
            
            \\\`\\\`\\\`
            ${results}
            \\\`\\\`\\\`
            
            </details>
            
            ---
            
            **‚úÖ Routing Verification:**
            - http://foo.localhost ‚Üí foo service
            - http://bar.localhost ‚Üí bar service
            
            **üîç Key Metrics Captured:**
            - HTTP request duration (avg, p50, p90, p95, p99)
            - Percentage of failed HTTP requests
            - Requests/second handled by each service
            - Complete percentile distribution
            
            *Generated by GitHub Actions CI workflow*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster || true