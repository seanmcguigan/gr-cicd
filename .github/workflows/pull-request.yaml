name: Goodnotes Load Testing CI

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install KinD
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Create KinD cluster
        run: |
          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          - role: worker
          - role: worker
          EOF

      - name: Verify cluster nodes
        run: |
          kubectl get nodes
          kubectl wait --for=condition=Ready nodes --all --timeout=300s

      - name: Install NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          
      - name: Wait for Ingress Controller
        run: |
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=300s

      - name: Deploy http-echo applications
        run: |
          # Create foo deployment
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foo
            labels:
              app: foo
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: foo
            template:
              metadata:
                labels:
                  app: foo
              spec:
                containers:
                - name: http-echo
                  image: hashicorp/http-echo:latest
                  args:
                    - "-text=foo"
                  ports:
                  - containerPort: 5678
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 5
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foo-service
          spec:
            selector:
              app: foo
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5678
          EOF

          # Create bar deployment
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: bar
            labels:
              app: bar
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: bar
            template:
              metadata:
                labels:
                  app: bar
              spec:
                containers:
                - name: http-echo
                  image: hashicorp/http-echo:latest
                  args:
                    - "-text=bar"
                  ports:
                  - containerPort: 5678
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 5678
                    initialDelaySeconds: 5
                    periodSeconds: 5
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: bar-service
          spec:
            selector:
              app: bar
            ports:
            - protocol: TCP
              port: 80
              targetPort: 5678
          EOF

      - name: Configure Ingress routing
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: echo-ingress
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
          spec:
            ingressClassName: nginx
            rules:
            - host: foo.localhost
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: foo-service
                      port:
                        number: 80
            - host: bar.localhost
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: bar-service
                      port:
                        number: 80
          EOF

      - name: Wait for deployments to be ready
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/foo
          kubectl wait --for=condition=available --timeout=300s deployment/bar
          
          # Verify pods are running
          kubectl get pods -o wide
          
          # Verify ingress is configured
          kubectl get ingress

      - name: Verify ingress health
        run: |
          # port forward ingress controller to localhost
          kubectl port-forward --namespace ingress-nginx svc/ingress-nginx-controller 8080:80 &
          
          # Wait a bit for ingress to fully configure
          sleep 10
          
          # Test foo endpoint
          curl -H "Host: foo.localhost" http://localhost:8080/ || exit 1
          
          # Test bar endpoint
          curl -H "Host: bar.localhost" http://localhost:8080/ || exit 1
          
          echo "âœ… Both ingress endpoints are healthy"

      - name: Install Apache Bench for load testing
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils

      - name: Run load tests
        id: load_test
        run: |
          # Create load test script
          cat > load_test.sh << 'SCRIPT'
          #!/bin/bash
          
          OUTPUT_FILE="load_test_results.txt"
          > $OUTPUT_FILE
          
          echo "ðŸš€ Starting Load Tests" | tee -a $OUTPUT_FILE
          echo "===========================================" | tee -a $OUTPUT_FILE
          echo "" | tee -a $OUTPUT_FILE
          
          # Test parameters
          REQUESTS=1000
          CONCURRENCY=50
          DURATION=30
          
          # Function to run load test
          run_load_test() {
            local host=$1
            local url=$2
            
            echo "Testing $host" | tee -a $OUTPUT_FILE
            echo "-------------------------------------------" | tee -a $OUTPUT_FILE
            
            # Run Apache Bench
            ab -n $REQUESTS -c $CONCURRENCY -H "Host: $host" $url 2>&1 | tee -a ab_temp.txt
            
            # Extract key metrics
            echo "ðŸ“Š Results for $host:" | tee -a $OUTPUT_FILE
            
            grep "Requests per second:" ab_temp.txt | tee -a $OUTPUT_FILE
            grep "Time per request:" ab_temp.txt | head -2 | tee -a $OUTPUT_FILE
            grep "Failed requests:" ab_temp.txt | tee -a $OUTPUT_FILE
            grep "Complete requests:" ab_temp.txt | tee -a $OUTPUT_FILE
            
            echo "" | tee -a $OUTPUT_FILE
            echo "Percentile Response Times:" | tee -a $OUTPUT_FILE
            grep -A 6 "Percentage of the requests served" ab_temp.txt | tee -a $OUTPUT_FILE
            
            echo "" | tee -a $OUTPUT_FILE
            echo "===========================================" | tee -a $OUTPUT_FILE
            echo "" | tee -a $OUTPUT_FILE
            
            rm -f ab_temp.txt
          }
          
          # Run tests for both services with randomization
          echo "ðŸŽ¯ Testing FOO service..." | tee -a $OUTPUT_FILE
          run_load_test "foo.localhost" "http://localhost/"
          
          echo "ðŸŽ¯ Testing BAR service..." | tee -a $OUTPUT_FILE
          run_load_test "bar.localhost" "http://localhost/"
          
          # Mixed traffic test
          echo "ðŸ”€ Testing MIXED traffic (randomized)..." | tee -a $OUTPUT_FILE
          echo "-------------------------------------------" | tee -a $OUTPUT_FILE
          
          for i in {1..500}; do
            if [ $((i % 2)) -eq 0 ]; then
              curl -s -H "Host: foo.localhost" http://localhost/ > /dev/null &
            else
              curl -s -H "Host: bar.localhost" http://localhost/ > /dev/null &
            fi
            
            # Limit concurrent requests
            if [ $((i % 50)) -eq 0 ]; then
              wait
            fi
          done
          wait
          
          echo "âœ… Mixed traffic test completed (500 requests)" | tee -a $OUTPUT_FILE
          echo "" | tee -a $OUTPUT_FILE
          
          cat $OUTPUT_FILE
          SCRIPT
          
          chmod +x load_test.sh
          ./load_test.sh
          
          # Set output for PR comment
          echo "RESULTS<<EOF" >> $GITHUB_OUTPUT
          cat load_test_results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post results to PR
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.load_test.outputs.RESULTS }}`;
            
            const comment = `## ðŸ§ª Kubernetes Load Test Results
            
            **Cluster Configuration:**
            - Multi-node KinD cluster (3 nodes: 1 control-plane, 2 workers)
            - NGINX Ingress Controller
            - 2 http-echo deployments (foo and bar)
            
            **Test Configuration:**
            - Total Requests: 1000 per service
            - Concurrency: 50
            - Additional mixed traffic: 500 randomized requests
            
            ---
            
            \`\`\`
            ${results}
            \`\`\`
            
            ---
            
            **Routing Verification:**
            - âœ… http://foo.localhost â†’ foo service
            - âœ… http://bar.localhost â†’ bar service
            
            *Generated by GitHub Actions CI*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster || true